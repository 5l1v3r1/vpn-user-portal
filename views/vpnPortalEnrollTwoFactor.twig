{% if not requireTwoFactorEnrollment %}
    {% set activeItem = 'account' %}
{% endif %}
{% extends "base.twig" %}
{% block content %}
    {% if requireTwoFactorEnrollment %}
        <ul class="menu">
            <li class="active"><span>{% trans "Two-factor Enrollment" %}</span></li>
        </ul>

        <p class="success">
            {% trans %}
                In order to continue, you must first enroll for Two-factor authentication!
            {% endtrans %}
        </p>

    {% endif%} 

    {% if twoFactorMethods is empty %}
        <p>
            {% trans "Two-factor authentication (2FA) is disabled by the administrator." %}
        </p>
    {% else %}
        {% if hasTotpSecret %}
            <p class="success">
                {% trans "You are already enrolled for Two-factor authentication (2FA)." %}
            </p>
        {% else %}
            {% if "totp" in twoFactorMethods %}
                <p>
                    {% trans "Here you can enroll for two-factor authentication (2FA) using a Time-based One-time Password (TOTP)." %}
                    {% trans %}See the <a href="documentation">documentation</a> for more information on 2FA and a list of applications to use.{% endtrans %}
                </p>

                <dl>
                    <dt>{% trans "Secret" %}</dt>
                    <dd><code>{{ totpSecret }}</code></dd>
                    <dt>QR</dt>
                    <dd><img src="two_factor_enroll_qr?totp_secret={{ totpSecret }}"></dd>
                </dl>

                <p>
                    {% trans %}Scan the QR code using your 2FA application, or import the secret manually. Confirm the successful configuration by entering a 6 digit OTP generated by the application below. {% endtrans %}
                </p>

                {% if error_code is defined %}
                    {% if 'invalid_otp_code' == error_code %}
                        <p class="error">{% trans "The OTP key you entered does not match the expected value for this OTP secret." %}</p>
                    {% else %}
                        <p class="error">{{ error_code }}</p>
                    {% endif %}
                {% endif %}

                <form method="post">
                    <fieldset>
                        <label for="otp_key">OTP</label>
                        <input type="text" id="totp_key" inputmode="numeric" name="totp_key" autocomplete="off" maxlength="6" required pattern="[0-9]{6}" autofocus>
                        <input type="hidden" name="totp_secret" value="{{ totpSecret }}"> 
                    </fieldset>
                    <fieldset>
                        <button>{% trans "Verify" %}</button>
                    </fieldset>
                </form>
            {% endif %}
        {% endif %}
    {% endif %}
{% endblock %}
